{% extends "admin/base_site.html" %}
{% block content %}
<div id="content-main">
    <p>W√§hlen Sie f√ºr jedes St√ºck die entsprechende Quelldatei aus und erg√§nzen Sie bei Bedarf eine Beschreibung.</p>

    <div class="module">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; background: #f8f8f8;">
                    <th style="padding: 10px;">Nr. / Titel</th>
                    <th style="padding: 10px;">Audio-Datei (WAV/CDA)</th>
                    <th style="padding: 10px;">Beschreibung</th>
                    <th style="padding: 10px;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in program_items %}
                    <tr id="row-{{ item.piece.id }}" 
                        class="{% if item.existing_recording %}is-existing{% endif %}" 
                        style="border-bottom: 1px solid #eee; {% if item.existing_recording %}background-color: #f4f4f4; color: #666;{% endif %}">
                        
                        <td style="padding: 10px;">
                            <strong>{{ item.order }}. {{ item.piece.title }}</strong>
                            {% if item.existing_recording %}
                                <div style="font-size: 0.8em; color: #2c5282; margin-top: 4px;">
                                    üìÅ {{ item.existing_recording.audio_file.name }}<br>
                                    üìù <em>{{ item.existing_recording.description|default:"Keine Beschreibung" }}</em>
                                </div>
                            {% endif %}
                        </td>
                        
                        <td style="padding: 10px;">
                            {% if item.existing_recording %}
                                <span style="color: #2b6cb0;">‚úî Vorhanden</span>
                                <input type="file" class="audio-input" style="display:none;" data-piece-id="{{ item.piece.id }}">
                            {% else %}
                                <input type="file" class="audio-input" 
                                    data-piece-id="{{ item.piece.id }}" 
                                    data-order="{{ item.order }}"
                                    accept=".wav,.mp3">
                            {% endif %}
                        </td>
                        
                        <td style="padding: 10px;">
                            <input type="text" class="description-input" 
                                value="{{ item.existing_recording.description|default:'' }}"
                                {% if item.existing_recording %}disabled{% endif %}
                                style="width: 90%;">
                        </td>
                        
                        <td class="status-cell" style="padding: 10px;">
                            {% if item.existing_recording %}√úberspringen{% else %}Wartet...{% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="submit-row" style="margin-top: 20px;">
            <button type="button" id="start-btn" class="default" style="padding: 10px 20px; cursor: pointer;">
                üöÄ Konvertierung & Upload starten
            </button>
            <a href="{{ request.META.HTTP_REFERER }}" class="closelink">Abbrechen</a>
        </div>
    </div>
</div>



<script>
document.getElementById('start-btn').onclick = async function() {
    const inputs = document.querySelectorAll('.audio-input');
    const btn = this;
    
    if (!confirm("Die ausgew√§hlten Dateien werden nacheinander konvertiert und hochgeladen. Fortfahren?")) return;

    btn.disabled = true;
    btn.innerHTML = "‚åõ Verarbeitung l√§uft...";

    for (const input of inputs) {
        if (input.files.length === 0) continue;

        const row = input.closest('tr');
        const statusCell = row.querySelector('.status-cell');
        const descInput = row.querySelector('.description-input');
        
        statusCell.innerHTML = "‚è≥ L√§dt hoch & konvertiert...";
        row.style.backgroundColor = "#fff9e6";

        const formData = new FormData();
        formData.append('file', input.files[0]);
        formData.append('piece_id', input.dataset.pieceId);
        formData.append('concert_id', "{{ concert.id }}");
        formData.append('order_num', input.dataset.order);
        formData.append('description', descInput.value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 Minuten Timeout

            const response = await fetch('{% url "process_single_audio" %}', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`Server-Antwort: ${response.status}`);
            
            const result = await response.json();
            
            if (result.status === 'success') {
                statusCell.innerHTML = "‚úÖ Abgeschlossen";
                row.style.backgroundColor = "#d4edda";
                // Deaktiviere Inputs nach Erfolg
                input.disabled = true;
                descInput.disabled = true;
            } else {
                statusCell.innerHTML = "‚ùå Fehler: " + result.message;
                row.style.backgroundColor = "#f8d7da";
            }
        } catch (e) {
            statusCell.innerHTML = "‚ùå Abbruch: " + e.message;
            row.style.backgroundColor = "#f8d7da";
            console.error(e);
            btn.disabled = false;
            btn.innerHTML = "‚ö†Ô∏è Fehler aufgetreten - Erneut versuchen?";
            return; 
        }
    }
    
    btn.innerHTML = "‚úÖ Alle Aufgaben erledigt";
    btn.classList.remove('default');
    alert("Der Vorgang wurde abgeschlossen.");
};
</script>
{% endblock %}