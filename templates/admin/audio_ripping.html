{% extends "admin/base_site.html" %}
{% block content %}
<div id="content-main">
    <p>W√§hlen Sie f√ºr jedes St√ºck die entsprechende Quelldatei aus und erg√§nzen Sie bei Bedarf eine Beschreibung.</p>
    <p>Die Dateien sollten im WAV- oder MP3-Format vorliegen.</p>
    <p>Die Dateien werden nacheinander hochgeladen, in MP3 konvertiert und mit Metadaten versehen. Bitte warten Sie nach dem Klick auf "Starten" mit weiteren Aktionen, bis der Vorgang abgeschlossen ist.</p>
    <p>Hinweis: Bereits vorhandene Aufnahmen f√ºr ein St√ºck werden angezeigt. Wenn Sie weitere S√§tze einer Suite hinzuf√ºgen m√∂chten, verwenden Sie den Button "+ Weiterer Satz".</p>
    <p>Die Konvertierung erfolgt mit FFmpeg (sofern auf dem Server installiert). Sollte es zu Problemen kommen, werden Fehlermeldungen angezeigt und Sie k√∂nnen den Vorgang erneut starten.</p>
    <p>Nach Abschluss werden die Aufnahmen automatisch dem jeweiligen St√ºck zugeordnet.
    </p>

    <div class="module">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="text-align: left; background: #f8f8f8;">
                    <th style="padding: 10px;">Nr. / Titel</th>
                    <th style="padding: 10px;">Audio-Datei (WAV/MP3)</th>
                    <th style="padding: 10px;">Beschreibung</th>
                    <th style="padding: 10px;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in program_items %}
                    <tr id="row-{{ item.piece.id }}">
                        <td>
                            <strong>{{ item.order }}. {{ item.piece.title }}</strong>
                            <div class="existing-list" style="font-size: 0.8em; color: #666;">
                                {% for rec in item.existing_recordings.all %}
                                    <div>‚úî {{ rec.description|default:"Aufnahme" }}</div>
                                {% endfor %}
                            </div>
                            <button type="button" onclick="addSuiteRow('{{ item.piece.id }}')" style="margin-top:5px; font-size:10px;">+ Weiterer Satz</button>
                        </td>
                        <td><input type="file" class="audio-input" data-piece-id="{{ item.piece.id }}"></td>
                        <td><input type="text" class="description-input" placeholder="z.B. 1. Satz"></td>
                        <td class="status-cell">Bereit</td>
                    </tr>
                    {% endfor %}
            </tbody>
        </table>

        <div class="submit-row" style="margin-top: 20px;">
            <button type="button" id="start-btn" class="default" style="padding: 10px 20px; cursor: pointer;">
                üöÄ Konvertierung & Upload starten
            </button>
            <a href="{{ request.META.HTTP_REFERER }}" class="closelink">Abbrechen</a>
        </div>
    </div>
</div>



<script>
document.getElementById('start-btn').onclick = async function() {
    const inputs = document.querySelectorAll('.audio-input');
    const btn = this;
    
    if (!confirm("Die ausgew√§hlten Dateien werden nacheinander konvertiert und hochgeladen. Fortfahren?")) return;

    btn.disabled = true;
    btn.innerHTML = "‚åõ Verarbeitung l√§uft...";

    for (const input of inputs) {
        if (input.files.length === 0) continue;

        const row = input.closest('tr');
        const statusCell = row.querySelector('.status-cell');
        const descInput = row.querySelector('.description-input');
        
        statusCell.innerHTML = "‚è≥ L√§dt hoch & konvertiert...";
        row.style.backgroundColor = "#fff9e6";

        const formData = new FormData();
        formData.append('audio_file', input.files[0]);
        formData.append('piece_id', input.dataset.pieceId);
        formData.append('concert_id', "{{ concert.id }}");
        formData.append('order_num', input.dataset.order);
        formData.append('description', descInput.value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 Minuten Timeout

            const response = await fetch('{% url "process_single_audio" %}', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`Server-Antwort: ${response.status}`);
            
            const result = await response.json();
            
            if (result.status === 'success') {
                statusCell.innerHTML = "‚úÖ Abgeschlossen";
                row.style.backgroundColor = "#d4edda";
                // Deaktiviere Inputs nach Erfolg
                input.disabled = true;
                descInput.disabled = true;
            } else {
                statusCell.innerHTML = "‚ùå Fehler: " + result.message;
                row.style.backgroundColor = "#f8d7da";
            }
        } catch (e) {
            statusCell.innerHTML = "‚ùå Abbruch: " + e.message;
            row.style.backgroundColor = "#f8d7da";
            console.error(e);
            btn.disabled = false;
            btn.innerHTML = "‚ö†Ô∏è Fehler aufgetreten - Erneut versuchen?";
            return; 
        }
    }
    
    btn.innerHTML = "‚úÖ Alle Aufgaben erledigt";
    btn.classList.remove('default');
    alert("Der Vorgang wurde abgeschlossen.");
};

// Function to add a new row for additional movements/s√§tze of a piece (suite support)
function addSuiteRow(pieceId) {
    const originalRow = document.querySelector(`#row-${pieceId}`);
    const newRow = originalRow.cloneNode(true);
    newRow.id = ""; // remove id to avoid duplicates
    newRow.querySelector('.audio-input').value = "";
    newRow.querySelector('.description-input').value = "";
    newRow.querySelector('.status-cell').innerHTML = "Bereit (Zusatz)";
    newRow.querySelector('.existing-list').innerHTML = ""; //empty existing recordings for new row
    originalRow.parentNode.insertBefore(newRow, originalRow.nextSibling);
}

</script>
{% endblock %}